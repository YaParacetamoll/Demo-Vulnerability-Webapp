<?php

// Database connection (vulnerable to SQL injection if not handled properly)
$conn = mysqli_connect("database", "posty", "123456", "posty");

// Check connection
if (!$conn) {
    die("Connection failed: " . mysqli_connect_error());
}

// Session Management (for login status)
session_start();

// Handle login/signup/post actions (vulnerable to various attacks if not sanitized and validated)
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    if (isset($_POST["login"])) {
        $username = $_POST["username"];
        $password = $_POST["password"];

        // IMPORTANT: Sanitize and validate input before using it in a query!
        // ... (e.g., use mysqli_real_escape_string() or prepared statements) ...

        // Query the database to check if the username and password match
        $sql = "SELECT * FROM users WHERE username = '$username' AND password = '$password'"; // Vulnerable to SQL injection!

        $result = mysqli_query($conn, $sql);

        if (mysqli_num_rows($result) == 1) {
            // Login successful
            $row = mysqli_fetch_assoc($result);
            $_SESSION["user_id"] = $row["id"]; // Store user ID in session
            $_SESSION["username"] = $row["username"];
            header("Location: index.php"); // Redirect to the same page (or a different page if needed)
            exit();
        } else {
            // Login failed
            $login_error = "Invalid username or password.";
        }
    } elseif (isset($_POST["signup"])) {
        // ... signup logic ... 
        // (Handle user registration, store user data in the database, etc.)
        echo "Signup logic goes here"; // Replace with actual signup handling
    } elseif (isset($_POST["post"])) {
        // ... post creation logic ...
        if (isset($_SESSION["user_id"])) { // Check if user is logged in
            $content = $_POST["content"];

            // IMPORTANT: Sanitize and validate input before using it in a query!
            // ... (e.g., use mysqli_real_escape_string() or prepared statements) ...

            $user_id = $_SESSION["user_id"];
            $sql = "INSERT INTO posts (user_id, content) VALUES ('$user_id', '$content')"; // Vulnerable to SQL injection!
            if (mysqli_query($conn, $sql)) {
                // Post created successfully
                header("Location: index.php"); // Redirect after posting
                exit();
            } else {
                // Error creating post
                $post_error = "Error creating post. Please try again.";
            }
        } else {
            // User not logged in, redirect to login
            header("Location: index.php");
            exit();
        }
    } elseif (isset($_POST["delete"])) {
        // ... post deletion logic ... 
        if (isset($_SESSION["user_id"])) { // Check if user is logged in
            $post_id = $_POST["post_id"];

            // IMPORTANT: Sanitize and validate input before using it in a query!
            // ... (e.g., use mysqli_real_escape_string() or prepared statements) ...

            $sql = "DELETE FROM posts WHERE id = '$post_id' AND user_id = '{$_SESSION["user_id"]}'"; // Vulnerable to SQL injection!
            if (mysqli_query($conn, $sql)) {
                // Post deleted successfully
                header("Location: index.php"); // Redirect after deleting
                exit();
            } else {
                // Error deleting post
                $delete_error = "Error deleting post. Please try again.";
            }
        } else {
            // User not logged in, redirect to login
            header("Location: index.php");
            exit();
        }
    }
}

// Fetch and display posts (potential for XSS if output is not escaped) - Only if logged in
if (isset($_SESSION["user_id"])) {
    $sql = "SELECT p.*, u.username 
            FROM posts p
            INNER JOIN users u ON p.user_id = u.id
            ORDER BY p.timestamp DESC";
    $result = mysqli_query($conn, $sql);
}

mysqli_close($conn);
?>

<!DOCTYPE html>
<html>

<head>
    <title>Posty Social Media App</title>
    <!-- Bootstrap 2 and jQuery CDN links -->
    <link rel="stylesheet" href="/public/bootstrap/css/bootstrap.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="/public/jquery/jquery-3.7.1.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="/public/bootstrap/js/bootstrap.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Include CKEditor (replace with your preferred rich text editor) -->
    <script src="/public/ckeditor/ckeditor.js" ></script>
    <script>
        const interval = setInterval(
            () => {
                if ($(".cke_notifications_area").length == 1) {
                    clearInterval(interval)
                    console.log("Interval Clear")

                }
                $(".cke_notifications_area").remove()
            }, 1
        )
    </script>
    <style>
        .post {
            border: 1px solid #ccc;
            padding: 15px;
            margin-top: 15px;
            margin-bottom: 15px;
            /* -webkit-border-radius: 5px;
            -moz-border-radius: 5px;
            border-radius: 5px;*/
        }

        .post-actions {
            margin-top: 10px;
        }
    </style>
</head>

<body>

    <div class="navbar">
        <div class="navbar-inner">
            <a class="brand" href="index.php">Posty Social Media App</a>
            <ul class="nav">
                <?php if (isset($_SESSION["user_id"])) : ?>
                    <li class="active"><a href="index.php">Home</a></li>
                    <li><a href="profile.php">Profile</a></li>
                    <!-- Add more navigation links for logged-in users here -->
                <?php else : ?>
                    <li class="active"><a href="index.php">Login</a></li>
                    <li><a href="signup.php">Sign Up</a></li>
                <?php endif; ?>
            </ul>
        </div>
    </div>

    <div class="container">

        <?php if (isset($_SESSION["user_id"])) : ?>
            <!-- User is logged in -->
            <div class="hero-unit">
                <h1>Welcome, <?php echo $_SESSION["username"]; ?>! </h1>
                <p><a href="logout.php">Logout</a></p>
                <p>
                    <!-- Post Button (to toggle post form) -->
                    <button id="showPostFormBtn" class="btn btn-primary">Create New Post</button>
                </p>
                <!-- Post Form (with CKEditor, initially hidden) -->
                <div id="postForm" style="display: none;">
                    <form method="post">
                        <?php if (isset($post_error)) : ?>
                            <div class="alert alert-error"><?php echo $post_error; ?></div>
                        <?php endif; ?>
                        <div class="control-group">
                            <textarea class="form-control" name="content" id="editor1" rows="10" cols="80"></textarea>
                            <script>
                                CKEDITOR.replace('editor1');
                            </script>
                        </div>
                        <button type="submit" class="btn btn-success" name="post">Post</button>
                    </form>
                </div>
            </div>



            <!-- Display Posts -->
            <?php if (isset($result) && mysqli_num_rows($result) > 0) : ?>
                <?php while ($row = mysqli_fetch_assoc($result)) : ?>
                    <div class="post">
                        <p><strong> <i class="icon-user icon-4x"></i><?php echo htmlspecialchars($row["username"]); ?></strong></p>
                        <hr />
                        <div class="post-content"><?php echo $row["content"]; ?></div> <!-- Note: No htmlspecialchars() here for XSS testing -->

                        <?php if ($row["user_id"] == $_SESSION["user_id"] || $_SESSION["user_id"] == "1") : ?>
                            <!-- Show edit/delete buttons for the logged-in user's posts OR if the user is admin -->
                            <div class="post-actions">
                                <a href="edit_post.php?post_id=<?php echo $row["id"]; ?>" class="btn btn-warning btn-mini">Edit</a>
                                <form method="post" style="display: inline-block;">
                                    <?php if (isset($delete_error)) : ?>
                                        <div class="alert alert-error"><?php echo $delete_error; ?></div>
                                    <?php endif; ?>
                                    <input type="hidden" name="post_id" value="<?php echo $row["id"]; ?>">
                                    <button type="submit" class="btn btn-danger btn-mini" name="delete">Delete</button>
                                </form>
                            </div>
                        <?php endif; ?>
                    </div>
                <?php endwhile; ?>
            <?php else : ?>
                <p>No posts yet.</p>
            <?php endif; ?>

        <?php else : ?>
            <!-- User is not logged in -->
            <div class="row">
                <div class="span4 offset4">
                    <h2 class="text-center">Login</h2>
                    <?php if (isset($login_error)) : ?>
                        <div class="alert alert-error"><?php echo $login_error; ?></div>
                    <?php endif; ?>
                    <form method="post" class="">
                        <div class="control-group" style="width: 100%">
                            <label for="username">Username:</label>
                            <input class="input-block-level" type="text" id="username" name="username" placeholder="Enter username" required>
                        </div>
                        <div class="control-group">
                            <label for="password">Password:</label>
                            <input class="input-block-level" type="password" id="password" name="password" placeholder="Enter password" required>
                        </div>
                        <div class="control-group">
                            <button type="submit" style="width: 100%" class="btn btn-primary btn-block" name="login">Login</button>
                        </div>
                    </form>
                    <p class="text-center">Don't have an account? <a href="signup.php">Sign Up</a></p>
                </div>
            </div>
        <?php endif; ?>

    </div>

    <script>
        $(document).ready(function() {
            $("#showPostFormBtn").click(function() {
                $("#postForm").toggle();

            });
        });
    </script>


</body>

</html>

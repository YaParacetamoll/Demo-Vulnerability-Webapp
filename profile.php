<?php

// Database connection (vulnerable to SQL injection if not handled properly)
$conn = mysqli_connect("database", "posty", "123456", "posty");

// Check connection
if (!$conn) {
    die("Connection failed: " . mysqli_connect_error());
}

// Session Management (for login status)
session_start();



// Get the profile user ID (either from query parameter or session)
if (isset($_GET["u_id"])) {
    $profile_user_id = $_GET["u_id"];
    
    // IMPORTANT: Sanitize and validate $profile_user_id 
    // ... (e.g., use mysqli_real_escape_string() or prepared statements) ... 
} else {
    $profile_user_id = $_SESSION["user_id"]; // Viewing own profile
}

// Fetch user's details
$sql = "SELECT * FROM users WHERE id = '$profile_user_id'"; 
$userResult = mysqli_query($conn, $sql);

if (mysqli_num_rows($userResult) == 1) {
    $user = mysqli_fetch_assoc($userResult);
} else {
    // User not found, redirect to index.php or another page
    header("Location: index.php"); 
    exit();
}

// Handle update profile
if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST["update_profile"])) {
    $newUsername = $_POST["new_username"];
    $newPassword = $_POST["new_password"];

    // IMPORTANT: Sanitize and validate input before using it in a query!
    // ... (e.g., use mysqli_real_escape_string() or prepared statements) ...

    // Update username if provided
    if (!empty($newUsername)) {
        $sql = "UPDATE users SET username = '$newUsername' WHERE id = '".$_SESSION["user_id"]."'";
        if (mysqli_query($conn, $sql)) {
            $_SESSION["username"] = $newUsername; // Update session variable
            $update_success = "Profile updated successfully.";
        } else {
            $update_error = "Error updating username: " . mysqli_error($conn);
        }
    }

    // Update password if provided
    if (!empty($newPassword)) {
        // IMPORTANT: Hash the new password before storing it in the database!
        // $hashed_password = password_hash($newPassword, PASSWORD_DEFAULT);

        $sql = "UPDATE users SET password = '$newPassword' WHERE id = '".$_SESSION["user_id"]."'"; // Vulnerable to SQL injection! Use hashing!
        if (!mysqli_query($conn, $sql)) {
            $update_error = "Error updating password: " . mysqli_error($conn);
        }
    }

    // Redirect to refresh profile data
    if (!isset($update_error)) {
        header("Location: profile.php");
        exit();
    }
}


// Fetch user's posts
$sql = "SELECT p.*, u.username 
        FROM posts p
        INNER JOIN users u ON p.user_id = u.id
        WHERE p.user_id = '$profile_user_id' 
        ORDER BY p.timestamp DESC"; 
$result = mysqli_query($conn, $sql);

mysqli_close($conn);
?>



<!DOCTYPE html>
<html>

<head>
    <title>Profile - Posty Social Media App</title>
    <!-- Bootstrap 2 and jQuery CDN links -->
    <link rel="stylesheet" href="/public/bootstrap/css/bootstrap.min.css" integrity="sha512-PPF4Ro4RnY0j7HQaRROfnlPF8P9/N4TLAxxfsS3NRV3GJteyVgxlZI7VZdsx9WFzNTnY8zHYmsrYTunVjHMcew==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="/public/jquery/jquery-3.7.1.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="/public/bootstrap/js/bootstrap.min.js" integrity="sha512-A2dQxBTz96fHrNddEW8qS5ozJLtAP8nFw7ZyPqPNUy8pSQRVwOIjM/6nLXGhgBGSo4XJPqJFKFX5XkAqo4reag==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        .post {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 15px;
        }

        .post-actions {
            margin-top: 10px;
        }
    </style>
</head>

<body>

    <div class="navbar">
        <div class="navbar-inner">
            <a class="brand" href="index.php">Posty Social Media App</a>
            <ul class="nav">
                <?php if (isset($_SESSION["user_id"])) : ?>
                    <li><a href="index.php">Home</a></li>
                    <li class="active"><a href="profile.php">Profile</a></li>
                    <!-- Add more navigation links for logged-in users here -->
                <?php else : ?>
                    <li><a href="index.php">Login</a></li>
                    <li><a href="signup.php">Sign Up</a></li>
                <?php endif; ?>
            </ul>
        </div>
    </div>

    <div class="container">
        <div class="well">
            <h1><?php echo htmlspecialchars($user["username"]); ?>'s Profile</h1>
        </div>

        <!-- Profile Update Form (only if viewing own profile) -->
        <?php if (isset($_SESSION["user_id"]) && $profile_user_id == $_SESSION["user_id"]) : ?>
            <div class="row">
                <div class="span4">
                    <h3>Update Profile</h3>
                    <?php if (isset($update_success)) : ?>
                        <div class="alert alert-success"><?php echo $update_success; ?></div>
                    <?php endif; ?>
                    <?php if (isset($update_error)) : ?>
                        <div class="alert alert-error"><?php echo $update_error; ?></div>
                    <?php endif; ?>
                    <form method="post" action="profile.php">
                        <div class="control-group">
                            <label for="new_username">New Username:</label>
                            <input type="text" class="form-control" id="new_username" name="new_username" placeholder="Enter new username">
                        </div>
                        <div class="control-group">
                            <label for="new_password">New Password:</label>
                            <input type="password" class="form-control" id="new_password" name="new_password" placeholder="Enter new password">
                        </div>
                        <button type="submit" class="btn btn-primary" name="update_profile">Update Profile</button>
                    </form>
                </div>
                <div class="span8">
                    <!-- Posts will be displayed here -->
                    <h2>Posts</h2>
                    <?php if (mysqli_num_rows($result) > 0) : ?>
                        <?php while ($row = mysqli_fetch_assoc($result)) : ?>
                            <div class="post">
                                <p><?php echo $row["content"]; ?></p> <!-- Note: No htmlspecialchars() here for XSS testing -->
                                <?php if ($profile_user_id == $_SESSION["user_id"]) : ?>
                                    <div class="post-actions">
                                        <a href="edit_post.php?post_id=<?php echo $row["id"]; ?>" class="btn btn-warning btn-mini">Edit</a>
                                        <form method="post" action="profile.php" style="display: inline-block;">
                                            <input type="hidden" name="post_id" value="<?php echo $row["id"]; ?>">
                                            <button type="submit" class="btn btn-danger btn-mini" name="delete">Delete</button>
                                        </form>
                                    </div>
                                <?php endif; ?>
                            </div>
                        <?php endwhile; ?>
                    <?php else : ?>
                        <p>No posts yet.</p>
                    <?php endif; ?>
                </div>
            </div>
        <?php endif; ?>

        <?php if (!isset($_SESSION["user_id"]) || $profile_user_id != $_SESSION["user_id"]) : ?>
            <div class="row">
                <div class="span12">
                    <h2>Posts</h2>
                    <?php if (mysqli_num_rows($result) > 0) : ?>
                        <?php while ($row = mysqli_fetch_assoc($result)) : ?>
                            <div class="post">
                                <p><?php echo $row["content"]; ?></p> <!-- Note: No htmlspecialchars() here for XSS testing -->
                                <?php if (isset($_SESSION["user_id"]) && $profile_user_id == $_SESSION["user_id"]) : ?>
                                    <div class="post-actions">
                                        <a href="edit_post.php?post_id=<?php echo $row["id"]; ?>" class="btn btn-warning btn-mini">Edit</a>
                                        <form method="post" action="profile.php" style="display: inline-block;">
                                            <input type="hidden" name="post_id" value="<?php echo $row["id"]; ?>">
                                            <button type="submit" class="btn btn-danger btn-mini" name="delete">Delete</button>
                                        </form>
                                    </div>
                                <?php endif; ?>
                            </div>
                        <?php endwhile; ?>
                    <?php else : ?>
                        <p>No posts yet.</p>
                    <?php endif; ?>
                </div>
            </div>
        <?php endif; ?>
    </div>

</body>

</html>
